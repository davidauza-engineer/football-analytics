<div class="step-text">
<p>Typically, when working with data, we need to use the results of one query execution in the second query. For example, we need to select the tuples where the value from one column is equal to the max value in another column. We can do it with simple subqueries: select the max value and in the main query select the tuples which are equal to this value. Thankfully, SQL has a powerful tool to combine queries â€” <strong>subqueries</strong>. Let's have a look at it!</p><p>A <strong>subquery</strong> (also called an <strong>inner or nested query</strong>) is a query within another SQL query (called a <strong>main or outer query</strong>). Subqueries can be nested within <code class="language-sql">SELECT</code>, <code class="language-sql">UPDATE</code>, <code class="language-sql">INSERT</code>, and <code class="language-sql">DELETE</code> statements.</p><h5 id="subqueries-nested-in-select-statement">Subqueries nested in SELECT statement</h5><p>Subqueries nested in <code class="language-sql">SELECT</code> statements are the most common type of subqueries. A subquery may occur in the <code class="language-sql">SELECT</code> clause, in the <code class="language-sql">FROM</code> clause, and in the <code class="language-sql">WHERE</code> clause of the <code class="language-sql">SELECT</code> statement.</p><p>Let's have a look at the following example.</p><p>Table <code class="language-sql">registered_users</code> has two columns: <code class="language-sql">username</code> and <code class="language-sql">sign_up_date</code> :</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 320px;"><tbody><tr><th><p>username</p></th><th><p>sign_up_date</p></th></tr><tr><td><p>timbrown</p></td><td><p>2012-12-04</p></td></tr><tr><td><p>awesometomas</p></td><td><p>2014-11-06</p></td></tr><tr><td><p>darlingKate</p></td><td><p>2012-12-04</p></td></tr><tr><td><p>frMartin</p></td><td><p>2014-07-03</p></td></tr></tbody></table><p>We will use a query with a subquery nested into the <code class="language-sql">WHERE</code> clause to select the first registered users:</p><pre><code class="language-sql">SELECT
    username,
    sign_up_date 
FROM
    registered_users 
WHERE
    sign_up_date = (
        SELECT 
            MIN(sign_up_date) 
        FROM 
            registered_users
    ); </code></pre><p>The result of the query will look as follows:</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 320px;"><tbody><tr><th><p>username</p></th><th><p>sign_up_date</p></th></tr><tr><td><p>timbrown</p></td><td><p>2012-12-04</p></td></tr><tr><td><p>darlingKate</p></td><td><p>2012-12-04</p></td></tr></tbody></table><p>The subquery from the example above is a <strong>single-row subquery</strong>. In this case, it is safe to use simple SQL comparison operators (=, &gt;, &lt;=, e.t.c.), because we can be sure that our query will return only one row with one column.</p><p>If we use a subquery along with comparison operators and our subquery returns more than one row, we will get an error. This doesn't mean that you can't use the <strong>multiple-row subquery </strong>that will return one or more rows, just use a multiple-row comparison operator, such as IN and ANY.</p><p>We can use<strong> </strong>a subquery to select one of the columns in the <code class="language-sql">SELECT</code> statement to add new columns to the result set.</p><p>Let's select all data from our table <code class="language-sql">registered_users</code> and add some more info from the table <code class="language-sql">users_info</code> given below:</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 430px;"><tbody><tr><th><p>username</p></th><th><p>name</p></th><th><p>birth_date</p></th></tr><tr><td><p>awesometomas</p></td><td><p>Tomas Jones</p></td><td><p>1995-10-07</p></td></tr><tr><td><p>timbrown</p></td><td><p>Tim Brown</p></td><td><p>2000-11-04</p></td></tr><tr><td><p>frMartin</p></td><td><p>Martin Brown</p></td><td><p>2002-12-04</p></td></tr><tr><td><p>darlingKate</p></td><td><p>Kate Brown</p></td><td><p>2005-03-03</p></td></tr></tbody></table><p>We will select all the information from the <code class="language-sql">registered_users</code> table and add all the corresponding information about the actual user names from the <code class="language-sql">users_info</code><em> </em>table:</p><pre><code class="language-sql">SELECT *, 
    (SELECT 
         name 
     FROM 
         users_info 
     WHERE 
         username = registered_users.username) AS name 
FROM
    registered_users</code></pre><p>The result will look as follows:</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 397px;"><tbody><tr><th><p>username</p></th><th><p>sign_up_date</p></th><th><p>name</p></th></tr><tr><td><p>timbrown</p></td><td><p>2012-12-04</p></td><td><p>Tim Brown</p></td></tr><tr><td><p>awesometomas</p></td><td><p>2014-11-06</p></td><td><p>Tomas Jones</p></td></tr><tr><td><p>darlingKate</p></td><td><p>2012-12-04</p></td><td><p>Kate Brown</p></td></tr><tr><td><p>frMartin</p></td><td><p>2014-07-03</p></td><td><p>Martin Brown</p></td></tr></tbody></table><p>As we've already mentioned, you can also use a subquery in the <code class="language-sql">FROM</code> clause of the <code class="language-sql">SELECT</code> statement.<strong> </strong>In this case, a <strong>derived table</strong> (a table that we obtain with subquery) has to be aliased.</p><p>The subqueries can be <strong>correlated</strong>. Correlated subqueries use values from the outer query.</p><p>Let's have a look at the example of a correlated subquery. Here is the table <code class="language-sql">new_orders</code> with the columns <code class="language-sql">id</code> INT, <code class="language-sql">product</code> VARCHAR(40), <code class="language-sql">product_category</code> VARCHAR(40), <code class="language-sql">quantity</code><em> </em>INT and <code class="language-sql">unit_price</code><em> </em>INT<em>:</em></p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 500px;"><tbody><tr><th><p>id</p></th><th><p>product</p></th><th><p>product_category</p></th><th><p>quantity</p></th><th><p>unit_price</p></th></tr><tr><td><p>1234</p></td><td><p>table</p></td><td><p>furniture</p></td><td><p>10</p></td><td><p>15</p></td></tr><tr><td><p>3434</p></td><td><p>chair</p></td><td><p>furniture</p></td><td><p>15</p></td><td><p>20</p></td></tr><tr><td><p>4546</p></td><td><p>bed</p></td><td><p>furniture</p></td><td><p>12</p></td><td><p>10</p></td></tr><tr><td><p>5467</p></td><td><p>candle</p></td><td><p>decor</p></td><td><p>45</p></td><td><p>40</p></td></tr><tr><td><p>3244</p></td><td><p>sticker</p></td><td><p>decor</p></td><td><p>40</p></td><td><p>14</p></td></tr><tr><td><p>3456</p></td><td><p>frame</p></td><td><p>decor</p></td><td><p>34</p></td><td><p>12</p></td></tr></tbody></table><p>We will use a correlated subquery to select all the products with a unit price less than the average in the product category:</p><pre><code class="language-sql">SELECT 
    id,
    product 
FROM
    new_orders AS newor 
WHERE unit_price &lt; (
    SELECT 
        AVG(unit_price) 
    FROM 
        new_orders
    WHERE 
        product_category = newor.product_category);</code></pre><p>While query results are evaluated, the correlated subquery will be executed for each row in the table, so evaluating the query with subquery for large tables can take a lot of time.</p><h5 id="subqueries-nested-in-the-update-statement">Subqueries nested in the UPDATE statement</h5><p>The subqueries can also be used with the <code class="language-sql">UPDATE</code> statement.</p><p>Let's update the table <code class="language-sql">students</code><em> </em>with the columns <code class="language-sql">name</code> VARCHAR(40), <code class="language-sql">scholarship</code> INT, and <code class="language-sql">exams_passed</code> BOOLEAN:</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 500px;"><tbody><tr><th><p>name</p></th><th><p>scholarship</p></th><th><p>exams_passed</p></th></tr><tr><td><p>Tom Jones</p></td><td><p>200</p></td><td><p>FALSE</p></td></tr><tr><td><p>Tamara Fetch</p></td><td><p>400</p></td><td><p>FALSE</p></td></tr><tr><td><p>Anthony Pots</p></td><td><p>300</p></td><td><p>FALSE</p></td></tr></tbody></table><p>As with the <code class="language-sql">SELECT</code>, we can use the <code class="language-sql">UPDATE</code> statement with a subquery nested into the <code class="language-sql">WHERE</code> clause. We will use this type of query with a subquery to set <code class="language-sql">exams_passed</code> to <code class="language-sql">TRUE</code> if in the <code class="language-sql">exam_results</code><em> </em>table both exams marks are greater or equal to 18. The table <code class="language-sql">exam_results</code> looks as follows (<code class="language-sql">name</code> VARCHAR(40), <code class="language-sql">math_exam_mark</code> INT, and <code class="language-sql">english_exam_mark</code> INT): </p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 500px;"><tbody><tr><th><p>name</p></th><th><p><em>math_exam_mark</em></p></th><th><p><em>english_exam_mark</em></p></th></tr><tr><td><p>Tom Jones</p></td><td><p>22</p></td><td><p>23</p></td></tr><tr><td><p>Tamara Fetch</p></td><td><p>18</p></td><td><p>15</p></td></tr><tr><td><p>Anthony Pots</p></td><td><p>18</p></td><td><p>18</p></td></tr></tbody></table><p>To update the table <code class="language-sql">students</code> we can use this query:</p><pre><code class="language-sql">UPDATE
    students 
SET
    exams_passed = TRUE 
WHERE 
    name IN (
        SELECT
            name
        FROM
            exam_results 
        WHERE
            math_exam_mark &gt;= 18
            AND english_exam_mark &gt;= 18
        ); </code></pre><p>After the execution of the query above, our table <code class="language-sql">students</code> will look as follows:</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 500px;"><tbody><tr><th><p>name</p></th><th><p>scholarship</p></th><th><p>exams_passed</p></th></tr><tr><td><p>Tom Jones</p></td><td><p>200</p></td><td><p>TRUE</p></td></tr><tr><td><p>Tamara Fetch</p></td><td><p>400</p></td><td><p>FALSE</p></td></tr><tr><td><p>Anthony Pots</p></td><td><p>300</p></td><td><p>TRUE</p></td></tr></tbody></table><p>We can also use the <code class="language-sql">UPDATE</code> query with a subquery to set the modified value. We will use the query below to set <em>scholarship</em> column values equal to the minimal scholarship for all students who did not pass the exams. Suppose that the scholarship amounts are stored in the <code class="language-sql">scholarships</code> table.</p><pre><code class="language-sql">UPDATE
    students 
SET
    scholarship = (
        SELECT 
            MIN(amount)
        FROM scholarships
    ) 
WHERE
    exam_passed = FALSE; </code></pre><p>Now Tamara Fetch will have a scholarship equal to 200:</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 500px;"><tbody><tr><th><p>name</p></th><th><p>scholarship</p></th><th><p>exams_passed</p></th></tr><tr><td><p>Tom Jones</p></td><td><p>200</p></td><td><p>TRUE</p></td></tr><tr><td><p>Tamara Fetch</p></td><td><p>200</p></td><td><p>FALSE</p></td></tr><tr><td><p>Anthony Pots</p></td><td><p>300</p></td><td><p>TRUE</p></td></tr></tbody></table><h5 id="subqueries-nested-in-the-insert-statement">Subqueries nested in the INSERT statement</h5><p>In the <code class="language-sql">INSERT</code> statement, we can use a subquery to insert the data returned from the subquery into another table.</p><p>In the example below we will work with the table <code class="language-sql">employees</code> with the columns <code class="language-sql">name</code> VARCHAR(20), <code class="language-sql">salary</code> INT and <code class="language-sql">department_id</code> INT:</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 500px;"><tbody><tr><th><p>name</p></th><th><p>salary</p></th><th><p>department_id</p></th></tr><tr><td><p>Ann Reed</p></td><td><p>4000</p></td><td><p>1</p></td></tr></tbody></table><p>All the data about departments is stored in the table <code class="language-sql">departments</code> with the columns <code class="language-sql">id</code> INT and <code class="language-sql">department</code> VARCHAR(20):</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 246px;"><tbody><tr><th><p>id</p></th><th><p>department</p></th></tr><tr><td><p>1</p></td><td><p>HR</p></td></tr><tr><td><p>2</p></td><td><p>IT</p></td></tr><tr><td><p>3</p></td><td><p>PR</p></td></tr></tbody></table><p>Let's add to the <code class="language-sql">employees</code> table the info about Tomas Hedwig who works in the PR department and with a salary equal to Ann Reed's salary. To get the salary and department IDs we will use subqueries as shown below:</p><pre><code class="language-sql">INSERT INTO employees 
VALUES (
    'Tomas Hedwig', 
    (SELECT salary FROM employees WHERE name = 'Ann Reed'), 
    (SELECT id FROM departments WHERE department = 'PR')
)</code></pre><p>After the query execution the <code class="language-sql">employees</code><em> </em>table will have two rows:</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 500px;"><tbody><tr><th><p>name</p></th><th><p>salary</p></th><th><p>department_id</p></th></tr><tr><td><p>Ann Reed</p></td><td><p>4000</p></td><td><p>1</p></td></tr><tr><td><p>Tomas Hedwig</p></td><td><p>4000</p></td><td><p>3</p></td></tr></tbody></table><h5 id="subqueries-nested-in-the-delete-statement">Subqueries nested in the DELETE statement</h5><p>We can also use subqueries in the <code class="language-sql">DELETE</code> statement as a part of the condition in the <code class="language-sql">WHERE</code> clause.</p><p>Assume that we have the table <code class="language-sql">orders</code> with columns <code class="language-sql">order_id</code><em> </em>INT<em>, </em><code class="language-sql">customer_id</code> INT, <code class="language-sql">product</code> VARCHAR(20), and <code class="language-sql">city</code> VARCHAR(20):</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 500px;"><tbody><tr><th><p>order_id</p></th><th><p>customer_id</p></th><th><p>product</p></th><th><p>city</p></th></tr><tr><td><p>1</p></td><td><p>1</p></td><td><p>shampoo</p></td><td><p>London</p></td></tr><tr><td><p>2</p></td><td><p>1</p></td><td><p>hair mask</p></td><td><p>London</p></td></tr><tr><td><p>3</p></td><td><p>2</p></td><td><p>hair mask</p></td><td><p>London</p></td></tr></tbody></table><p>And another table <code class="language-sql">customers</code> with columns <code class="language-sql">customer_id</code> INT and <code class="language-sql">name</code> VARCHAR(40):</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 313px;"><tbody><tr><th><p>customer_id</p></th><th><p>name</p></th></tr><tr><td><p>1</p></td><td><p>Ann Smith</p></td></tr><tr><td><p>2</p></td><td><p>John Doe</p></td></tr><tr><td><p>3</p></td><td><p>Sam Brown</p></td></tr></tbody></table><p>We will delete from the table <code class="language-sql">orders</code> all the orders made by Ann Smith:</p><pre><code class="language-sql">DELETE FROM orders
WHERE customer_id = (SELECT customer_id FROM customers WHERE name = 'Ann Smith')</code></pre><p>After the query execution, the <code class="language-sql">orders</code><em> </em>table will look as follows:</p><table align="center" border="1" cellpadding="1" cellspacing="1" style="width: 500px;"><tbody><tr><th><p>order_id</p></th><th><p>customer_id</p></th><th><p>product</p></th><th><p>city</p></th></tr><tr><td><p>3</p></td><td><p>2</p></td><td><p>hair mask</p></td><td><p>London</p></td></tr></tbody></table><p>Same as with the <code class="language-sql">UPDATE</code>, you cannot use the same table in the query and subquery in the <code class="language-sql">DELETE</code> statement.</p><h5 id="conclusion">Conclusion</h5><p>In this topic, we've learned about the different types of subqueries. Now you know that we can use subqueries in the different parts of the query and with the different types of statements. Let's get to practice then!</p>
</div>